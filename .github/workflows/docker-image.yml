name: Build docker image

on:
  push:
    tags:
      - "*"
    branches:
      - main
      - "3.3.*"
  workflow_dispatch:
    # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –ª—é–±–æ–π –≤–µ—Ç–∫–∏

jobs:
  build-docker-image:
    runs-on: ubuntu-latest # –ò–∑–º–µ–Ω–µ–Ω–æ —Å self-hosted –Ω–∞ ubuntu-latest –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version and commit
        id: vars
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            # –î–ª—è –∫–æ–º–º–∏—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º short SHA
            VERSION="dev-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          COMMIT="$(echo ${{ github.sha }} | cut -c1-7)"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "COMMIT=$COMMIT" >> $GITHUB_OUTPUT
          echo "üì¶ –í–µ—Ä—Å–∏—è: $VERSION, –ö–æ–º–º–∏—Ç: $COMMIT"

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/remnawave-telegram-shop-bot
          tags: |
            # latest —Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏ –∏ —Ç–µ–≥–æ–≤
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref_type == 'tag' }}
            # –í–µ—Ä—Å–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–¥–ª—è –≤—Å–µ—Ö –≤–µ—Ç–æ–∫)
            type=raw,value=${{ steps.vars.outputs.VERSION }}
            # –î–ª—è –≤–µ—Ç–∫–∏ 3.3.* —Å–æ–∑–¥–∞–µ–º —Ç–µ–≥ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –≤–µ—Ç–∫–∏
            type=raw,value=3.3.x-${{ steps.vars.outputs.VERSION }},enable=${{ startsWith(github.ref, 'refs/heads/3.3.') }}
            # Semver —Ç–µ–≥–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è git —Ç–µ–≥–æ–≤
            type=semver,pattern={{version}},enable=${{ github.ref_type == 'tag' }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ github.ref_type == 'tag' }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.vars.outputs.VERSION }}
            COMMIT=${{ steps.vars.outputs.COMMIT }}
            GITHUB_REPOSITORY=${{ github.repository }}
